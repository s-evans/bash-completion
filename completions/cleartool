#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>.
#
# Copyright (C) Jan Tomka, 1999-2011
#

# Rational ClearCase Completion
# author: Jan Tomka
# date: 2015-06-09
# source: http://jan.tomka.name/project/clearcase-completion-bash

# TODO: add support for branches and versions of files

# TODO: add caching and improved completion for
# streams
# projects
# activities
# baselines

# NOTE:
# Setting _cleartool_auto_init_cache initializes the cache when this completion
# file is loaded (ie. during first completion request)

# NOTE:
# Cache can be manually (re-)initialized by calling _cleartool_init_cache

# NOTE:
# Enabling caching may negatively impact the accuracy of completion candidates
# suggested to the user

_cleartool_init_cache()
{
    declare -g -A _cleartool_cache_view_uuids=""
    declare -g -A _cleartool_cache_views=""
    declare -g -A _cleartool_cache_vobs=""
    declare -g _cleartool_caching=1
    _cleartool_load_cache > /dev/null
    _cleartool_init_cache_internal > /dev/null
    _cleartool_save_cache > /dev/null
}

_cleartool_save_cache()
{
    mkdir -p ~/.cache/
    set | sed ' /^_cleartool_cache_/{ /^[^ ]*=(/{ :a /)$/!{ n; ba; }; b; }; / () $/{ :b /^}$/!{ n; bb; }; b; }; b; }; d; ' > ~/.cache/cleartool
}

_cleartool_load_cache()
{
    if [[ -e ~/.cache/cleartool ]]; then
        source ~/.cache/cleartool
    fi
}

_cleartool_init_cache_internal()
{
    _cleartool_vobs
    _cleartool_views
    _cleartool_view_uuids
}

_cleartool_vobs()
{
    if [[ "${_cleartool_cache_vobs}" ]]; then
        echo $_cleartool_cache_vobs
        return
    fi
    local IFS=$'\n'
    _cleartool_cache_vobs=$(printf '%q ' $(cleartool lsvob -short | sed 's/\r//') | sed 's/[:=]/\\&/g')
    echo $_cleartool_cache_vobs
}

_cleartool_mounted_vobs()
{
    if [[ "$_cleartool_caching" ]]; then
        _cleartool_vobs
        return
    fi
    local IFS=$'\n'
    printf '%q ' $(cleartool lsvob | sed '/^\*/d; s/^\s\+\(\S*\).*/\1/; s/\r//') | sed 's/[:=]/\\&/g' 
}

_cleartool_unmounted_vobs()
{
    if [[ "$_cleartool_caching" ]]; then
        _cleartool_vobs
        return
    fi
    local IFS=$'\n'
    printf '%q ' $(cleartool lsvob | sed '/^\*/d; s/^\s\+\(\S*\).*/\1/; s/\r//') | sed 's/[:=]/\\&/g'
}

_cleartool_view_uuids()
{
    if [[ "${_cleartool_cache_view_uuids}" ]]; then
        echo $_cleartool_cache_view_uuids
        return
    fi
    local IFS=$'\n'
    _cleartool_cache_view_uuids=$(printf '%q ' $(cleartool lsview -long | sed '/^View uuid: /!d; s/^View uuid: //; s/\r//' | sort | uniq) | sed 's/[:=]/\\&/g' )
    echo $_cleartool_cache_view_uuids
}

_cleartool_views()
{
    if [[ "${_cleartool_cache_views}" ]]; then
        echo $_cleartool_cache_views
        return
    fi
    local IFS=$'\n'
    _cleartool_cache_views=$(printf '%q ' $(cleartool lsview -short | sed 's/\r//') | sed 's/[:=]/\\&/g')
    echo $_cleartool_cache_views
}

_cleartool_started_views()
{
    if [[ "$_cleartool_caching" ]]; then
        _cleartool_views
        return
    fi
    local IFS=$'\n'
    # TODO: return only started views
    printf '%q ' $(cleartool lsview -short | sed 's/\r//') | sed 's/[:=]/\\&/g'
}

_cleartool_unstarted_views()
{
    if [[ "$_cleartool_caching" ]]; then
        _cleartool_views
        return
    fi
    local IFS=$'\n'
    # TODO: return only unstarted views
    printf '%q ' $(cleartool lsview -short | sed 's/\r//') | sed 's/[:=]/\\&/g'
}

_cleartool()
{
    local cur prev cword words commands options command pname
    _init_completion

    command=${words[1]}

    commands='annotate apropos catcr catcs cd chactivity chbl checkin ci
        checkout co checkvob chevent chflevel chfolder chmaster
        chpool chproject chstream chtype chview cptype deliver
        describe diff diffbl diffcr dospace edcs endview file find
        findmerge get getcache getlog help hostinfo ln lock ls
        lsactivity lsbl lscheckout lsco lsclients lscomp lsdo lsfolder
        lshistory lslock lsmaster lspool lsprivate lsproject lsregion
        lsreplica lssite lsstgloc lsstream lstype lsview lsvob lsvtree
        man merge mkactivity mkattr mkattype mkbl mkbranch mkbrtype
        mkcomp mkdir mkelem mkeltype mkfolder mkhlink mkhltype mklabel
        mklbtype mkpool mkproject mkregion mkstgloc mkstream mktag
        mktrigger mktrtype mkview mkvob mount move mv protect
        protectvob pwd pwv quit rebase recoverview reformatview
        reformatvob register relocate rename reqmaster reserve
        rmactivity rmattr rmbl rmbranch rmcomp rmdo rmelem rmfolder
        rmhlink rmlabel rmmerge rmname rmpool rmproject rmregion
        rmstgloc rmstream rmtag rmtrigger rmtype rmver rmview rmvob
        schedule setactivity setcache setcs setplevel setsite setview
        shell space startview umount uncheckout unco unlock unregister
        unreserve update winkin'

    if [[ $cword -eq 1 ]] ; then
        COMPREPLY=( $( compgen -W '$commands' -- $(printf '%q' $cur) ) )
    else
        if [[ "$cur" == -* ]]; then
            # Command-specific option flags
            case $command in
                annotate)
                    options='-all -rm -nco -out -short \
                        -long -fmt -rmfmt -nheader -ndata \
                        -force'
                    ;;
                apropos)
                    options='-glossary'
                    ;;
                catcr)
                    options='-recurse -flat -union -check \
                        -makefile -select -ci -type \
                        -element_only -view_only \
                        -critical_only -name -zero -wd -nxname \
                        -follow -long -short -scripts_only'
                    ;;
                catcs)
                    options='-tag'
                    ;;
                chactivity)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -headline -cfset \
                        -tcset'
                    ;;
                chbl)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -incremental -full \
                        -nrecurse -level'
                    ;;
                checkin|ci)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -nwarn -cr -ptime \
                        -keep -rm -from -identical -cact \
                        -cwork'
                    ;;
                checkout|co)
                    # TODO: list branches
                    options='-reserved -unreserved \
                        -nmaster -out -ndata -ptime -branch \
                        -version -nwarn -comment -cfile \
                        -cquery -cqeach -ncomment -query \
                        -nquery'
                    ;;
                checkvob)
                    options='-view -log -fix -force \
                        -ignore -data -protections -debris \
                        -setup -pool -source -derived \
                        -cleartext -lock -hlinks -to -from \
                        -hltype -pname -global -acquire \
                        -unlock'
                    ;;
                chevent)
                    options='-comment -cquery -cfile \
                        -cqeach -ncomment -append -insert \
                        -replace -event -invob -pname'
                    ;;
                chflevel)
                    options='-force -override -family \
                        -replica -auto'
                    ;;
                chfolder)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -to'
                    ;;
                chmaster)
                    options='-comment -comment -cfile \
                        -cquery -cqeach -ncomment -pname \
                        -stream -override -default -pname -all \
                        -obsolete_replica -long -view'
                    ;;
                chpool)
                    options='-force -comment -cfile \
                        -cquery -cqeach -ncomment'
                    ;;
                chproject)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -amodcomp -dmodcomp \
                        -to -rebase_level -policy -npolicy \
                        -spolicy -crmenable -ncrmenable'
                    ;;
                chstream)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -target -ntarget \
                        -generate -policy -npolicy \
                        -recommended -default -nrecommended'
                    ;;
                chtype)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -pname'
                    ;;
                chview)
                    options='-cachesize -shareable_dos \
                        -nshareable_dos -readonly -readwrite'
                    ;;
                cptype)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force -replace'
                    ;;
                deliver)
                    options='-graphical -stream -to \
                        -target -query -qall -cancel -status \
                        -long -preview -activities -baseline \
                        -complete -gmerge -ok -abort -serial \
                        -force -resume'
                    ;;
                # describe
                des*)
                    options='-graphical -local -long \
                        -short -fmt -alabel -all -aattr -all \
                        -ahlink -cview -version -ancestor \
                        -ihlink -all -predecessor -pname -type \
                        -cact -cwork'
                    ;;
                diff)
                    options='-graphical -tiny -hstack \
                        -vstack -predecessor -options -window \
                        -serial_format -diff_format -columns'
                    ;;
                diffbl)
                    options='-activities -version \
                        -baselines -first_only -nrecurs \
                        -predecessor -graphical'
                    ;;
                diffcr)
                    options='-recurse -flat -select -ci \
                        -type -element_only -view_only \
                        -critical_only -name -wd -nxname \
                        -follow -long -short'
                    ;;
                dospace)
                    options='-update -since -before \
                        -references -top -all -size -region \
                        -pool -dump -scrub'
                    ;;
                edcs)
                    options='-tag'
                    ;;
                endview)
                    options='-server'
                    ;;
                file)
                    options='-invob -all'
                    ;;
                find)
                    options='-all -visible -nvisible \
                        -avobs -name -depth -nrecurse \
                        -directory -cview -user -group -type \
                        -kind -follow -nxname -element -branch \
                        -version -print -exec -ok'
                    ;;
                findmerge)
                    options='-graphical -all -avobs -ftags \
                        -fversion -flatest -depth -nrecurse \
                        -directory -follow -visible -fcsets \
                        -user -group -type -name -element \
                        -nzero -nback -whynot -log -comment \
                        -cfile -cquery -cqeach -ncomment \
                        -unreserved -query -abort -qall \
                        -serial -btag -fbtag -rpint -long \
                        -short -nxname -merge -okmerge -gmerge \
                        -okgmerge -exec -ok -co'
                    ;;
                get)
                    options='-to'
                    ;;
                getcache)
                    options='-view -all -short -reset \
                        -cview -site -host -mvfs'
                    ;;
                getlog)
                    options='-graphical -host -cview -tag \
                        -vob -last -full -since -around \
                        -inquire -all'
                    ;;
                hostinfo)
                    options='-long -properties -full'
                    ;;
                ln)
                    options='-slink -comment -cfile \
                        -cquery -cqeach -ncomment -nco -force'
                    ;;
                lock)
                    options='-replace -nusers -obsolete \
                        -comment -cfile -cquery -cqeach \
                        -ncomment -pname'
                    ;;
                ls)
                    options='-recurse -directory -long \
                        -short -vob_only -view_only -nxname \
                        -visible'
                    ;;
                lsactivity)
                    options='-short -long -fmt -tree \
                        -depth -ancestor -obsolete -invob -in \
                        -view -cview -contrib'
                    ;;
                lsbl)
                    options='-short -long -fmt -tree \
                        -level -ltlevel -gtlevel -component \
                        -obsolete -stream -cview'
                    ;;
                lscheckout|lsco)
                    options='-long -short -fmt -cview \
                        -brtype -me -user -recurse -directory \
                        -all -avobs -areplicas'
                    ;;
                lsclients)
                    options='-host -type -short -long'
                    ;;
                lscomp)
                    options='-short -long -fmt -tree \
                        -obsolete -invob'
                    ;;
                lsdo)
                    options='-recurse -me -logn -short \
                        -fmt -zero -stime -sname \
                        -nshareable_dos'
                    ;;
                lsfolder)
                    options='-short -long -fmt -tree \
                        -depth -ancestor -obsolete -invob -in \
                        -view -cview'
                    ;;
                lshistory)
                    options='-graphical -nopreferences \
                        -minor -nco -user -branch -recurse \
                        -directory -all -avobs -pname -long \
                        -short -fmt -eventid -last -since -me \
                        -local -pname'
                    ;;
                lslock)
                    options='-local -long -short -fmt \
                        -obsolete -all -pname'
                    ;;
                lsmaster)
                    options='-kind -fmt -view -inreplicas \
                        -all'
                    ;;
                lspool)
                    options='-long -short -fmt -obsolete \
                        -invob'
                    ;;
                lsprivate)
                    options='-tag -invob -long -short \
                        -size -age -co -do -other'
                    ;;
                lsproject)
                    options='-short -long -fmt -tree \
                        -depth -ancestor -obsolete -invob -in \
                        -view -cview'
                    ;;
                lsregion)
                    options='-short -long'
                    ;;
                lsreplica)
                    options='-long -short -fmt -siblings \
                        -invob'
                    ;;
                lssite)
                    options='-inquire'
                    ;;
                lsstgloc)
                    options='-view -vob -short -long \
                        -region -host -storage'
                    ;;
                lsstream)
                    options='-short -long -fmt -tree \
                        -depth -ancestor -obsolete -invob -in \
                        -view -cview'
                    ;;
                lstype)
                    options='-local -long -short -fmt \
                        -obsolete -kind -invob'
                    ;;
                lsview)
                    options='-short -long -host -quick \
                        -properties -full -text_mode -age \
                        -region -cview -storage -uuid'
                    ;;
                lsvob)
                    options='-graphical -region -short \
                        -long -host -quick -region -storage \
                        -uuid -family'
                    ;;
                lsvtree)
                    options='-graphical -all -nmerge \
                        -ncomment -options -nrecurse -short \
                        -all -merge -obsolete -branch'
                    ;;
                man)
                    options='-graphical'
                    ;;
                merge)
                    options='-out -to -graphical -tiny \
                        -window -serial_format -diff_format \
                        -columns -base -insert -delete -ndata \
                        -narrows -replace -query -abort -qall \
                        -comment -cfile -cquery -cqeach \
                        -ncomment -options -version'
                    ;;
                mkactivity)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -headline -in -nset \
                        -force'
                    ;;
                mkattr)
                    options='-replace -recurse -version \
                        -pname -comment -cfile -cquery -cqeach \
                        -ncomment -default -select -ci -type \
                        -name -config'
                    ;;
                mkattype)
                    options='-replace -global -acquire \
                        -ordinary -vpelement -vpbranch \
                        -vpversion -shared -vtype -gt -ge -lt \
                        -le -enum -default -comment -cfile \
                        -cquery -cqeach -ncomment'
                    ;;
                mkbl)
                    options='-comment -cfile -cquery \
                        -ncomment -view -component -all \
                        -activities -nlabel -incremental -full \
                        -dentical -adepends_on -ddepends_on \
                        -nact -import'
                    ;;
                mkbranch)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -nwarn -nco \
                        -version'
                    ;;
                mkbrtype)
                    options='-replace -global acquire \
                        -ordinary -pbranch -comment -cfile \
                        -cquery -cqeach -ncomment'
                    ;;
                mkcomp)
                    options='-comment -cfile -cquery -root \
                        -nroot'
                    ;;
                mkdir)
                    options='-nco -comment -cfile -cquery \
                        -cqeach -ncomment'
                    ;;
                mkelem)
                    options='-eltype -nco -ci -ptime \
                        -master -nwarn -comment -cfile -cquery \
                        -cqeach -ncomment'
                    ;;
                mkeltype)
                    options='-replace -global -acquire \
                        -ordinary -supertype -manager -ptime \
                        -attype -mergetype -comment -cfile \
                        -cquery -cqeach -ncomment'
                    ;;
                mkfolder)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -in'
                    ;;
                mkhlink)
                    options='-unidir -ttext -ftext -tpname \
                        -fpname -acquire -comment -cfile \
                        -cquery -cqeach -ncomment'
                    ;;
                mkhltype)
                    options='-replace -global -acquire \
                        -ordinary -attype -shared -comment \
                        -cfile -cquery -cqeach -ncomment'
                    ;;
                mklabel)
                    options='-replace -recurse -follow \
                        -version -comment -cfile -cquery \
                        -cqeach -ncomment -select -ci -type \
                        -name -config'
                    ;;
                mklbtype)
                    options='-replace -global -acquire \
                        -rodinary -pbranch -shared -comment \
                        -cfile -cquery -cqeach -ncomment'
                    ;;
                mkpool)
                    options='-source -ln -comment -cfile \
                        -cquery -cqeach -ncomment -derived \
                        -cleartext -size -age -alert -update'
                    ;;
                mkproject)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -modcomp -policy \
                        -npolicy -spolicy -crmenable -in'
                    ;;
                mkregion)
                    options='-tag -tcomment -replace'
                    ;;
                mkstgloc)
                    options='-view -vob -force -comment \
                        -region -host -hpath -gpath -ngpath \
                        -host -hpath'
                    ;;
                mkstream)
                    options='-integration -in -target \
                        -comment -cfile -cquery -cqeach \
                        -ncomment -baseline -policy -npolicy'
                    ;;
                mktag)
                    options='-view -tag -tcomment -replace \
                        -region -nstart -ncaexported -host \
                        -gpath -ngpath -vob -options -public \
                        -password'
                    ;;
                mktrigger)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -recurse -ninherit \
                        -nattach -force -nattach'
                    ;;
                mktrtype)
                    options='-replace -element -all -type \
                        -ucmobject -all -preop -postop -nusers \
                        -exec -execunix -execwin -mklabel \
                        -mkattr -mkhlink -attype -brtype \
                        -eltype -hltype -lbtype -trtype \
                        -project -stream -component -comment \
                        -cfile -cquery -cqeach -ncomment'
                    ;;
                mkview)
                    options='-tag -tcommen -tmode -region \
                        -ln -ncaexported -cachesize \
                        -shareable_dos -nshareable_dos -stream \
                        -tgloc -auto -host -hpath -gpath \
                        -snapshot'
                    ;;
                mkvob)
                    options='-tag -ucmproject -comment \
                        -cfile -cquery -cqeach -ncomment \
                        -tcomment -region -options \
                        -ncaexported -public -password -host \
                        -hpath -gpath -stgloc -auto'
                    ;;
                mount)
                    options='-options -all'
                    ;;
                move|mv)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment'
                    ;;
                protect)
                    options='-chown -chgrp -chmod -comment \
                        -cfile -cquery -cqeach -ncomment -file \
                        -directory -recurse -pname'
                    ;;
                protectvob)
                    options='-force -chown -chgrp \
                        -add_group -delete_group'
                    ;;
                pwv)
                    options='-short -wdview -setview \
                        -root'
                    ;;
                rebase)
                    options='-graphical -view -stream \
                        -query -qall -cancel -status -long \
                        -recommended -baseline -dbaseline \
                        -complete -gmerge -ok -abort -serial \
                        -force -resume'
                    ;;
                recoverview)
                    options='-synchronize -vob -tag -force \
                        -directory'
                    ;;
                reformatview)
                    options='-dump -load -tag'
                    ;;
                reformatvob)
                    options='-dump -load -rm -force -to \
                        -host -hpath'
                    ;;
                register)
                    options='-view -replace -host -hpath \
                        -vob'
                    ;;
                relocate)
                    options='-force -qall -log -update'
                    ;;
                rename)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -acquire'
                    ;;
                reqmaster)
                    options='-comment -cquery -ncomment \
                        -acl -edit -set -get -enable -disable \
                        -deny -allow -instances -list'
                    ;;
                reserve)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -cact -cwork'
                    ;;
                rmactivity)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force'
                    ;;
                rmattr)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -version -pname'
                    ;;
                rmbl)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force'
                    ;;
                rmbranch)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force'
                    ;;
                rmcomp)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force'
                    ;;
                rmdo)
                    options='-all -zero'
                    ;;
                rmelem)
                    options='-force -comment -cfile \
                        -cquery -cqeach -ncomment'
                    ;;
                rmfolder)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force'
                    ;;
                rmhlink)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment'
                    ;;
                rmlabel)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment \
                        -version'
                    ;;
                rmmerge)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment'
                    ;;
                rmname)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -nco \
                        -force'
                    ;;
                rmpool)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment'
                    ;;
                rmproject)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force'
                    ;;
                rmregion)
                    options='-tag -rmall -password'
                    ;;
                rmstgloc)
                    options='-all -region -storage -view \
                        -vob -short -long -host'
                    ;;
                rmstream)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force'
                    ;;
                rmtag)
                    options='-view -region -all -vob \
                        -password'
                    ;;
                rmtrigger)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment \
                        -ninherit -nattach -recurse'
                    ;;
                rmtype)
                    options='-ignore -rmall -force \
                        -comment -cfile -cquery -cqeach \
                        -ncomment'
                    ;;
                rmver)
                    options='-force -xbranch -xlabel \
                        -xattr -xhlink -data -version -vrange \
                        -comment -cfile -cquery -cqeach \
                        -ncomment'
                    ;;
                rmview)
                    options='-force -tag -vob -avobs -all \
                        -uuid'
                    ;;
                rmvob)
                    options='-force'
                    ;;
                schedule)
                    options='-host -force -edit -schedule \
                        -acl -get -job -tasks -set -delete \
                        -run -wait -status'
                    ;;
                setactivity)
                    options='-comment -cfile -cquery \
                        -ncomment -view -none'
                    ;;
                setcache)
                    options='-view -default -cachesize \
                        -cview -host -site -mvfs -regdnc \
                        -noentdnc -dirdnc -vobfree -cvpfree \
                        -rpchandles'
                    ;;
                setcs)
                    options='-tag -current -default \
                        -stream'
                    ;;
                setplevel)
                    options='-comment -cfile -cquery \
                        -ncomment -invob -default'
                    ;;
                setsite)
                    options='-password'
                    ;;
                setview)
                    options='-login -exec'
                    ;;
                space)
                    options='-view -vob -all -update \
                        -region -host -directory -generate \
                        -scrub'
                    ;;
                umount)
                    options='-all'
                    ;;
                uncheckout|unco)
                    options='-keep -rm -cact -cwork'
                    ;;
                unlock)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -pname'
                    ;;
                unregister)
                    options='-vob -uuid -view'
                    ;;
                unreserve)
                    options='-view -cact -cwork -comment \
                        -cfile -cquery -cqeach -ncomment'
                    ;;
                update)
                    options='-graphical -print -force \
                        -overwrite -noverwrite -rename -ctime \
                        -ptime -log -add_loadrules'
                    ;;
                winkin)
                    options='-print -noverwrite -siblings \
                        -adirs -out -select -ci'
                    ;;
            esac
            options="$options -h"

            COMPREPLY=( $( compgen -W '$options' -- $(printf '%q' $cur) ) )
        else
            # Command-specific arguments
            case "$command" in
                diff)
                    if [[ "$prev" == -options ]]; then
                        # TODO: list options
                        options='-blank_ignore'
                    fi
                    ;;
                help|apropos)
                    options="$commands"
                    ;;
                man)
                    options="$commands make clearmake \
                        clearaudit clearbug cleardiffbl \
                        cleargetlog clearhistory clearjoinproj \
                        clearvobadmin clearlicense clearmrgman \
                        clearprompt clearviewupdate \
                        clearfsimport clearexport_rcs \
                        clearexport_ccase cleardescribe \
                        clearexport_pvcs clearexport_sccs"
                    ;;
                mount)
                    options=$(_cleartool_unmounted_vobs)
                    ;;
                umount)
                    options=$(_cleartool_mounted_vobs)
                    ;;
                endview)
                    options=$(_cleartool_started_views)
                    ;;
                find)
                    case "$prev" in
                        -kind)
                            options='actype attype baseline branch brtype
                            checkpoint dbid delem do domain dover dver eltype felem
                            fver hlink hltype lbtype login oid pool replica
                            replicauuid role rptype sibrep slink state sttype
                            trtype user viewdb vob vobuuid wko lscomp lsfolder
                            lsproject lsstream'
                            ;;
                        -type)
                            options='f d l'
                            ;;
                        -user)
                            # TODO: list users
                            options=''
                            ;;
                        -group)
                            # TODO: list groups
                            options=''
                            ;;
                        -ver?(sion))
                            ;&
                        -ele?(ment))
                            ;&
                        -bra?(nch))
                            # TODO: this could be vastly improved
                            options='attr_sub() atttype() atttype_sub() brtype()
                            created_by() created_since() eltype() hltype() lbtype()
                            lbtype_sub() merge() pool() trtype() version()'
                            ;;
                    esac
                    ;;
                startview)
                    options=$(_cleartool_unstarted_views)
                    ;;
                setview)
                    if [[ "$prev" == -exe?(c) ]]; then
                        COMPREPLY=( $(compgen -A command -- $cur) )
                    else
                        options=$(_cleartool_views)
                    fi
                    ;;
                lshistory)
                    case $prev in
                        -branch)
                            options=$(printf '%q ' $(cleartool lstype -kind brtype -fmt '%n ') | sed 's/[:=]/\\&/g')
                            ;;
                    esac
                    ;;
                mkbranch)
                    case $prev in
                        -c|-comment)
                            options=''
                            ;;
                        -cfile)
                            options=''
                            ;;
                        -version)
                            options=''
                            ;;
                        -*|$command)
                            options=$(printf '%q ' $(cleartool lstype -kind brtype -fmt '%n ') | sed 's/[:=]/\\&/g')
                            ;;
                    esac
                    ;;
                lstype)
                    case $prev in
                        -kind)
                            options='attype brtype eltype hltype lbtype trtype'
                            ;;
                    esac
                    ;;
                lsview)
                    if [[ "$prev" == -hos?(t) ]]; then
                        _known_hosts
                    elif [[ "$prev" == -reg?(ion) ]]; then
                        options=$(cleartool lsregion -short | sed 's/\r//')
                        options=$(printf '%q\n' ${options})
                    elif [[ "$prev" == -sto?(rage) ]]; then
                        # TODO: Doesn't work OK.
                        options=$(_cleartool_views)
                    elif [[ "$prev" == -uui?(d) ]]; then
                        options=$(_cleartool_view_uuids)
                    else
                        options=$(_cleartool_views)
                    fi
                    ;;
                uncheckout|unco)
                    # List of user's checked out elements
                    # TODO: Include list of activities for checkin
                    local IFS=$'\n'
                    options=$(printf '%q\n' $(cleartool lscheckout -short -me | sed 's/\r//'))
                    ;;
                checkin|ci)
                    if [[ "$prev" != @(-fro?(m)|-cfi?(le)) ]]; then
                        local IFS=$'\n'
                        options=$(printf '%q\n' $(cleartool lscheckout -short -me | sed 's/\r//'))
                    fi
                    ;;
                lsregion)
                    # TODO: region caching
                    local IFS=$'\n'
                    options=$(printf '%q\n' $(cleartool lsregion -short | sed 's/\r//'))
                    ;;
                rmregion)
                    if [[ "$prev" != -pas?(sword) ]]; then
                        # TODO: region caching
                        local IFS=$'\n'
                        options=$(printf '%q\n' $(cleartool lsregion -short | sed 's/\r//'))
                    fi
                    ;;
                lsvob)
                    if [[ "$prev" == -reg?(ion) ]]; then
                        local IFS=$'\n'
                        options=$(printf '%q\n' $(cleartool lsregion -short | sed 's/\r//'))
                    elif [[ "$prev" == -hos?(t) ]]; then
                        _known_hosts
                    elif [[ "$prev" == -uui?(d) ]]; then
                        # TODO: vob uuid caching
                        local IFS=$'\n'
                        options=$(printf '%q\n' $(cleartool lsvob -long | sed '/^Vob replica uuid: /!d; s/^Vob replica uuid: //; s/\r//' | sort | uniq) | sed 's/[:=]/\\&/g')
                    elif [[ "$prev" == -fam?(ily) ]]; then
                        local IFS=$'\n'
                        options=$(printf '%q\n' $(cleartool lsvob -long | sed '/^Vob family uuid: /!d; s/^Vob family uuid: //; s/\r//' | sort | uniq) | sed 's/[:=]/\\&/g')
                    elif [[ "$prev" == -sto?(rage) ]]; then
                        # TODO: Doesn't work OK
                        local IFS=$'\n'
                        options=$(printf '%q\n' $(cleartool lsvob | sed 's/^\*\?\ \S*\s*\(\S*\).*/\1/; s/\r//') | sed 's/[:=]/\\&/g')
                    fi
                    ;;
            esac

            if [ -n "$options" -a -z "$COMPREPLY" ]; then
                COMPREPLY=( $(compgen -W '$options' -- $(printf '%q' $cur) ) )
            fi
        fi
    fi
}
complete -o default -F _cleartool cleartool ct cleartool.exe

_multitool()
{
    local cur prev cword words commands options command pname
    _init_completion

    command=${words[1]}

    commands="help man quit cd pwd shell apropos lstype rmtype mkreplica \
        chreplica syncreplica lsreplica rmreplica rename chmaster \
        lsmaster reqmaster lsepoch chepoch recoverpacket \
        restorereplica describe lspacket"

    if [[ $cword -eq 1 ]] ; then
        COMPREPLY=( $( compgen -W '$commands' -- $(printf '%q' $cur) ) )
    else
        if [[ "$cur" == -* ]]; then
            # Command-specific option flags
            case $command in
                man)
                    options='-graphical'
                    ;;
                apropos)
                    options='-glossary'
                    ;;
                lstype)
                    options='-local -long -short -fmt \
                        -obsolete -kind -invob'
                    ;;
                rmtype)
                    options='-ignore -rmall -force \
                        -comment -cfile -cquery -cqeach \
                        -ncomment'
                    ;;
                mkreplica)
                    options='-export -workdir -maxsize \
                        -comment -cfile -cquery -cqeach \
                        -ncomment -ship -fship -sclass \
                        -pexpire -notify -tape -out -import \
                        -tag -host -hpath -gpath -stgloc \
                        -preserve -tcomment -ncaexported \
                        -region -options -public -password \
                        -ignoreprot -pooltalk -vreplica -tape'
                    ;;
                chreplica)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -host -preserve \
                        -npreserve -isconnected -nconnected'
                    ;;
                syncreplica)
                    options='-export -maxsize -limit \
                        -comment -cfile -cquery -cqeach \
                        -ncomment -ship -fship -sclass \
                        -pexpire -notify -tape -out -import \
                        -invob -receive'
                    ;;
                lsreplica)
                    options='-long -short -fmt -siblings \
                        -invob'
                    ;;
                rmreplica)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment'
                    ;;
                rename)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -acquire'
                    ;;
                chmaster)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -pname -stream \
                        -override -default -pname -all \
                        -obsolete_replica -long -view'
                    ;;
                lsmaster)
                    options='-kind -fmt -view -inreplicas \
                        -all'
                    ;;
                reqmaster)
                    options='-comment -cquery -ncomment \
                        -acl -edit -set -get -enable -disable \
                        -deny -allow -instances -list'
                    ;;
                lsepoch)
                    options='-invob -actual'
                    ;;
                chepoch)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -force -actual \
                        -raise_only'
                    ;;
                recoverpacket)
                    options='-comment -cfile -cquery \
                        -cqeach -ncomment -since'
                    ;;
                restorereplica)
                    options='-comment -cfile -cq -cqe -nc \
                        -force -override -invob -replace'
                    ;;
                describe)
                    options='-graphical -local -long -short -fmt \
                        -alabel -all -aattr -ahlink -cview \
                        -version -ancestor -ihlink \
                        -predecessor -pname -type -cact -cwork'
                    ;;
                lspacket)
                    options='-long -short'
                    ;;
            esac
            options="$options -h"

            COMPREPLY=( $( compgen -W '$options' -- $(printf '%q' $cur) ) )
        else
            case "$command" in
                help|apropos|man)
                    options="$commands"
                    ;;
            esac

            if [ -n "$options" -a -z "$COMPREPLY" ]; then
                COMPREPLY=( $( compgen -W '$options' -- $(printf '%q' $cur) ) )
            fi
        fi
    fi
}
complete -o default -F _multitool multitool mt multitool.exe

_clearaudit()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-h" -- $cur ) )
    fi
}
complete -o default -A command -F _clearaudit clearaudit clearaudit.exe

_clearbug()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-short -p -r -l -h" -- $cur ) )
    fi
}
complete -o default -F _clearbug clearbug clearbug.exe

_cleardiffbl()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-ispred" -- $cur ) )
    fi
}
complete -o default -F _cleardiffbl cleardiffbl cleardiffbl.exe

_cleardiff()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-tiny -window -diff_format \
            -serial_format -columns -headers_only -quiet \
            -status_only -blank_ignore -out -base -q -qall -abort \
            -favor_contrib" -- $cur ) )
    fi
}
complete -o default -F _cleardiff cleardiff cleardiff.exe

_clearexport_ccase()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-r -s -I -t -T -p -o" -- $cur ) )
    fi
}
complete -o default -F _clearexport_ccase clearexport_ccase clearexport_ccase.exe

_clearexport_cvs()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-r -A -s -p -I -V -S -t -T -p -o" -- $cur ) )
    fi
}
complete -o default -F _clearexport_cvs clearexport_cvs clearexport_cvs.exe

_clearexport_rcs()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-r -s -p -I -V -S -t -T -o" -- $cur ) )
    fi
}
complete -o default -F _clearexport_rcs clearexport_rcs clearexport_rcs.exe

_clearexport_sccs()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-r -s -p -I -V -t -T -o" -- $cur ) )
    fi
}
complete -o default -F _clearexport_sccs clearexport_sccs clearexport_sccs.exe

_clearexport_ffile()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-r -o -L -s -l -b -v -p -t" -- $cur ) )
    fi
}
complete -o default -F _clearexport_ffile clearexport_ffile clearexport_ffile.exe

_clearexport_pvcs()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-r -s -I -G -V -t -T -p -o" -- $cur ) )
    fi
}
complete -o default -F _clearexport_pvcs clearexport_pvcs clearexport_pvcs.exe

_clearfsimport()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-follow -recurse -rmname -mklabel \
            -nsetevent -identical -master -comment \
            -unco -preview -h" -- $cur ) )
    fi
}
complete -o default -F _clearfsimport clearfsimport clearfsimport.exe

_cleargetlog()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-host -vob -cview -tag" -- $cur ) )
    fi
}
complete -o default -F _cleargetlog cleargetlog cleargetlog.exe

_clearhistory()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-nopreferences -minor -nco -user \
            -branch -recurse -directory -all -avobs -pname" -- $cur ) )
    fi
}
complete -o default -F _clearhistory clearhistory clearhistory.exe

_clearimport()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-verbose -identical -nsetevent
        -master -directory -comment -noload -nolabeldir -h" -- $cur ) )
    fi
}
complete -o default -F _clearimport clearimport clearimport.exe

_clearlicense()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-product -hostid -release" -- $cur ) )
    fi
}
complete -o default -F _clearlicense clearlicense clearlicense.exe

_clearmrgman()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-deliver -stream -to -target -query \
            -ttag -rebase -view -ftag -fbranch -flabel -fversion \
            -directory -nrecurse -follow -noautomerge -query -avobs \
            -qall -file" -- $cur ) )
    fi
}
complete -o default -F _clearmrgman clearmrgman clearmrgman.exe

_clearprompt()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-outfile -multi_line -default -dfile \
            -pattern -directory -items -choices -type \
            -mask -prompt -prefer_gui -newline -h" -- $cur ) )
    fi
}
complete -o default -F _clearprompt clearprompt clearprompt.exe

_clearviewupdate()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-ws -pname" -- $cur ) )
    fi
}
complete -o default -F _clearviewupdate clearviewupdate clearviewupdate.exe

_clearvobadmin()
{
    local cur prev cword words
    _init_completion
    if [[ "$cur" == -* ]]; then
        COMPREPLY=( $( compgen -W "-region" -- $cur ) )
    fi
}
complete -o default -F _clearvobadmin clearvobadmin clearvobadmin.exe

if [[ "$_cleartool_auto_init_cache" ]]; then
    _cleartool_init_cache
fi

# vi: ft=sh
