#!/usr/bin/env sh

_driverquery_users()
{
    local options IFS
    IFS=$'\n'
    local options=$(wmic useraccount get name | sed -e '1d' -e 's/\r//' -e 's/ \+$//' -e '/\$$/ d' -e '/^$/ d')
    printf '%q\n' ${options,,} | sed -e 's/[:=]/\\\&/g' -e "/''/d"
}

_driverquery()
{
    local cur prev words cword options IFS
    _init_completion

    # Command-specific arguments
    case $prev in

        /s|/p)
            ;;

        /fo)
            options='table list csv'
            ;;

        /u)
            IFS=$'\n'
            options=$(_driverquery_users)
            ;;

        *)
            options=('/s' '/fo' '/nh' '/si' '/v')

            case ${words[$cword-2]} in

                /s)
                    options+=('/u')
                    ;;

                /u)
                    options+=('/p')
                    ;;
            esac

            options=$(_compliment words[@]::cword options[@])
            ;;

    esac

    COMPREPLY=( $(compgen -W '${options}' -- ${cur} ) )
}

complete -o default -F _driverquery driverquery driverquery.exe

